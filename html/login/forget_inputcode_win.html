<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>忘记密码win</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
    <style>
        html{
            overflow: hidden;
        }
        body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
            background: linear-gradient(to bottom, #2eaab9, #599ccb) no-repeat;
        }

        header {
            background: rgba(0,0,0,0) !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 0.9375rem !important;
            color: #4f4f4f !important;
        }
        .aui-title{
            font-size: 0.9375rem;
            color: #fff;
            height: 100%;
            line-height: 45px;
        }
        header a:nth-child(1) span{
            color: #fff !important;
        }

        section {
            width: 100%;
            display: flex;
            box-sizing: border-box;
            flex-direction: column;
            padding: 7.26% 0px 0px 0px;
        }

        section>.aui-row{
            padding-left: 37.5px !important;
            padding-right: 39px !important;
            position: relative;
        }
        section img{
            display: inline-block;
            position: relative;
        }

        .aui-row:nth-child(1){
            padding-top: 34px;
            height: 135px;
            color: #fff;
        }
        .aui-row:nth-child(1)>div:nth-child(1) {
            font-size: 0.75rem;
        }
        .aui-row:nth-child(1)>div:nth-child(2) span{
            font-size: 0.875rem;
        }
        .aui-row:nth-child(1)>div:nth-child(1) small{
            font-size: 0.6875rem;
        }

        .aui-row:nth-child(2)>div:nth-child(1) {
            padding:  0px 0px;
            height: 48px;
        }
        .aui-row:nth-child(2)>div:nth-child(2) {
            padding-top: 13.5px;
        }
        .aui-row:nth-child(2)>div:nth-child(2)>span{
            display: none;
        }
        .aui-row:nth-child(2)>div:nth-child(1)>div {
            position: absolute;
            width: 191px;
            left: 50%;
            transform: translateX(-50%);
        }
        .aui-row:nth-child(2)>div:nth-child(1)>div>input {
            width: 29px;
            font-size: 1.125rem;
            color: #00d9d3;
            background: rgba(0, 0, 0, 0);
            border-bottom: solid 1px #b0dbe5;
            text-align: center;
            display: inline-block;
            margin-right: 20px;
        }
        .aui-row:nth-child(2)>div:nth-child(1)>div>input:last-child{
            margin-right: 0px;
        }
        .aui-row:nth-child(2)>div:nth-child(2){
            padding-top: 13px;
            font-size: 0.78125rem;
        }
        .aui-row:nth-child(2)>div:nth-child(2)>span:nth-child(1) {
            color: #e3f800;
        }
        .aui-row:nth-child(2)>div:nth-child(2)>button:nth-child(2) {
            color: #fff;
            display: contents;
            background: rgba(255,255,255,0);
            border: none;
        }

        .aui-row:nth-child(3) {
            height: 106px;
            padding: 27px 0px 17px;

        }
        .aui-row:nth-child(3) button {
            border-radius: 50px;
            border: none;
            font-size: 0.8125rem;
            -webkit-transition: background-color 0.2s;
            -moz-transition: background-color 0.2s;
            -ms-transition: background-color 0.2s;
            -o-transition: background-color 0.2s;
            transition: background-color 0.2s;
            background: #00e4ff;
            color: #fff;
        }
        .aui-row:nth-child(3) button[disabled="disabled"]{
            background:#367590;
            color: #efd6d6;
        }
        .aui-row:nth-child(3) button:active{
            background: #00c2dd;
        }

        .aui-row:nth-child(4) {
            padding: 0px !important;
            flex: 1;
            -webkit-flex:1 ;
            position: relative;
        }
    </style>
</head>
<body>
<header class="aui-bar aui-bar-nav">
    <a class="aui-pull-left aui-btn" onclick="closeThisWin()" tapmode>
        <span class="aui-iconfont aui-icon-left"></span>
    </a>
    <div class="aui-title">找回密码</div>
</header>
<section class="aui-content">
    <div class="aui-row aui-text-center">
        <div class="aui-col-xs-12 ">
            我们已发送验证码短信到您的手机:
        </div>
        <div class="aui-col-xs-12 ">
            <small>+86</small>
            <span>
                1234567895
            </span>
        </div>
    </div>
    <div class="aui-row">
        <div class="aui-col-xs-12">
            <div>
                <input type="number" size="1" maxlength="1" id="code1" oninput="codeOninput(1)">
                <input type="number" size="1" maxlength="1" id="code2" oninput="codeOninput(2)">
                <input type="number" size="1" maxlength="1" id="code3" oninput="codeOninput(3)">
                <input type="number" size="1" maxlength="1" id="code4" oninput="codeOninput(4)">
            </div>
        </div>
        <div class="aui-col-xs-12 aui-text-center">
            <span id="codeTime">60秒</span><button onclick="getCode()" tapmode>后重新发送验证码</button>
        </div>
    </div>
    <div class="aui-row">
        <button class="aui-btn aui-btn-primary aui-btn-block" id="loginBtn" onclick="btnClick(this)" tapmode>
            点击获取验证码
        </button>
    </div>
    <div class="aui-row">
    </div>
</section>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script>
    apiready=function () {
        api.parseTapmode();
        $api.fixStatusBar($api.dom('header'));//自适应沉浸式状态栏，不需要另外设置状态栏样式
        var systemType=api.systemType;
        getCode();

        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            closeThisWin();
        });

        document.querySelector(".aui-row:nth-child(1)>div:nth-child(2) span").innerHTML=api.pageParam.phone;

        setTimeout(function () {
            focusInput();
        },500);
    }

    /**
     * 验证码输入时一系列操作
     * */
    function codeOninput(num) {
        var dom=document.getElementById("code1");
        var val=document.getElementById("code"+num).value;
        var numReg=/^[0-9]{1}$/;
        //当输入框中无值，证明点击删除键
        if(val==""){
            document.getElementById("code"+num).setAttribute("style","border-bottom: solid 1px #b0dbe5;");
            if (num!=1){
                document.getElementById("code"+(num - 1)).focus();
            }
            document.getElementById("loginBtn").setAttribute("disabled","disabled");
        }
        //当输入框中输入值
        else {
            if (!numReg.test(val)){
                document.getElementById("code"+num).value=val.substring(0,1);
                return;
            }
            if (dom.value ==""){
                dom.value=document.getElementById("code"+num).value;
                document.getElementById("code1").setAttribute("style","border-bottom: solid 1px #00d9d3;");
                document.getElementById("code2").focus();
                document.getElementById("code"+num).value="";
                return;
            }
            document.getElementById("code"+num).setAttribute("style","border-bottom: solid 1px #00d9d3;");
            if (num !=4){
                document.getElementById("code"+(num + 1)).focus();
            }else {
                console.log("判断验证码是否正确");
            }
            var statuNum=0;
            for (var i = 1; i <= 4; i++) {
                var val=document.getElementById("code"+i).value;
                if (val !=""){
                    statuNum++;
                }
            }
            if(statuNum==4){
                document.getElementById("loginBtn").removeAttribute("disabled");
            }else {
                document.getElementById("loginBtn").setAttribute("disabled","disabled");
            }
        }
    }

    /**
     * 获取验证码
     * @param dom dom元素
     */
    function getCode() {
        document.getElementById("loginBtn").setAttribute("disabled","disabled");
        document.querySelector("#codeTime+button").setAttribute("disabled","disabled");
        var timeDom=document.getElementById("codeTime");
        var phone=api.pageParam.phone;
        var codeNum=60;
        var mac=api.deviceId;
        api.toast({
            msg: "发送成功",
            duration: 3000,
            location: 'top'
        });
        api.ajax({
            url: ip+'/api/app/communitywanli/login/getMobileVerificationCode',
            method: 'get',
            timeout: 10,
            dataType: 'json',
            returnAll: false,
            data: {
                values:{
                    cellphone: phone,
                    mac: mac,
                    type: 1
                }
            }
        },
            function (ret, err) {
            api.hideProgress();
            if (err!=""){
                api.toast({
                    msg: err.msg.message,
                    duration: 3000,
                    location: 'top'
                });
            }
        });

        document.getElementById("loginBtn").innerHTML="完成验证";
        document.getElementById("loginBtn").setAttribute("disabled","disabled");
        document.querySelector("#codeTime+button").innerHTML="后重新发送验证码";
        timeDom.setAttribute("style","display:inline-block");

        codeTimer=setInterval(function () {
            if (codeNum<=0){
                clearInterval(codeTimer);
                timeDom.innerHTML="收不到验证码？";
                document.querySelector("#codeTime+button").removeAttribute("disabled");
                document.querySelector("#codeTime+button").innerHTML="点击重新发送";
            }else {
                timeDom.innerHTML=codeNum--+"秒";
            }
        },1000);
    }

    /**
     * 最下面按钮单击事件
     * @param dom 按钮dom
     */
    function btnClick(dom) {
        var code="";
        var codeReg=/^[0-9]{4}$/;
        var codeArray=document.querySelectorAll(".aui-row:nth-child(2)>div:nth-child(1)>div>input");
        for (var i=0;i<codeArray.length;i++){
            code+=codeArray[i].value;
        }
        if (codeReg.test(code)){
            api.showProgress({
                title: '验证中',
                modal: false
            });
            var phone=api.pageParam.phone;
            var pw=code;
            var mac=api.deviceId;
            api.ajax({
                    url: ip+'/api/app/communitywanli/login/cellphoneVerification',
                    method: 'get',
                    timeout: 10,
                    dataType: 'json',
                    returnAll: false,
                    data: {
                        values: {
                            cellphone: phone,
                            mac: mac,
                            verificationCode: pw
                        },
                    }
                },
                function (ret, err) {
                    api.hideProgress();
                    if (ret!=""){
                        if (ret.resultStatus){
                            setTimeout(function () {
                                api.toast({
                                    msg: ret.message,
                                    duration: 3000,
                                    location: 'top'
                                });
                            },1000);
                            openSetPw(phone);
                        }
                        else {
                            api.toast({
                                msg: ret.message,
                                duration: 3000,
                                location: 'top'
                            });
                        }
                    }else {
                        api.toast({
                            msg: err.msg,
                            duration: 3000,
                            location: 'top'
                        });
                    }
                });
        }else {
            api.toast({
                msg: "验证码格式错误",
                duration: 3000,
                location: 'top'
            });
        }
        console.log("完成验证")
    }

    function closeThisWin() {
        api.closeWin();
    }

    /**
     * 电话输入框获得焦点，并且弹起软键盘
     */
    function focusInput(){
        // 使用模块弹出键盘
        var softInput = api.require('softInputMgr');
        softInput.toggleKeyboard();
        // 将相应的输入框获取焦点
        document.getElementById("code1").focus();
    }

    /**
     * @phone 手机号
     * 打开设置密码页面
     */
    function openSetPw(phone) {
        api.openWin({
            name: 'forget_set_pw_win',
            url: 'forget_set_pw_win.html',
            pageParam: {phone: phone},
            bgColor:"#fff",
        });
    }
</script>
</html>