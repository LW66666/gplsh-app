<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>添加报事报修frame</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../css/aui.css"/>
    <style>
        body, html {
            background: #fff;
        }

        .aui-list {
            background-image: none;
        }

        .aui-list .aui-list-item {
            padding-left: 24.5px;
            height: 47.5px;
        }

        .aui-list .aui-list-item-label {
            height: 47.5px;
            padding-right: 10px;
            font-size: .875rem;
        }

        .aui-list-item-input input {
            height: 47.5px;
            font-size: .6875rem;
            color: #9d9d9d;
        }

        .title-type {
            height: 47.5px;
            padding-left: 24.5px;
            font-size: .875rem;
            line-height: 47.5px;
        }

        .btn-type-group {
            width: calc(100% - 42px);
            -webkit-box-orient: horizontal;
            -webkit-flex-flow: row;
            flex-flow: row;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            margin: 0 auto;
        }

        .btn-type-group .btn-type {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
            font-size: .6875rem;
            padding-top: 10px;
        }

        .btn-type-group .btn-type img {
            width: 2.5rem;
            margin: 0 auto;
        }

        .btn-type-group .btn-type span {
            padding-top: 8px;
        }

        .bottom-sh {
            -webkit-box-shadow: 0 10px #f9f7f7;
            -moz-box-shadow: 0 10px #f9f7f7;
            box-shadow: 0 10px #f9f7f7;
            padding-bottom: 18px;
        }

        .input-text-div {
            position: relative;
            width: 100%;
            height: 160px;
            border-bottom: 1px solid #dadada;
        }

        .input-text-div textarea {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            height: 120px;
            font-size: 0.6875rem;
            outline: none;
        }

        .input-text-div .font-num {
            display: block;
            position: absolute;
            right: 10px;
            bottom: 10px;
        }

        .input-text-div .font-num span {
            font-size: 0.6875rem;
            color: #9d9d9d;
        }

        .select-img-group {
            position: relative;
            padding-top: 25px;
            margin: 0 auto;
            width: 100%;
            height: 130px;
            border-bottom: 1px solid #dadada;
            padding-left: calc(7.5% - 10px);
        }

        .select-img-group > div {
            display: inline-block;
            position: relative;
        }

        .btn-select-img {
            position: relative;
            width: 80px;
            height: 80px;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            max-width: 130px;
            max-height: 240px;
        }

        .btn-select-img:active {
            background: #c0c0c0;
        }

        .btn-select-img {
            margin-left: 10px;
        }

        .btn-select-img img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
        }

        .select-img-group > div .btn-close {
            position: absolute;
            z-index: 2;
            top: -5px;
            right: -5px;
            width: 1rem;
            height: 1rem;
            text-align: center;
            line-height: 1rem;
            border-radius: 50%;
            background-color: #fc2e09;
            color: #ffffff;
            -webkit-animation: shake;
            -o-animation: shake;
            animation: shake;
            animation-duration: 1.1s;
            animation-iteration-count: infinite;
        }

        @-webkit-keyframes shake {
            0% {
                transform: rotate(0deg)
            }
            12.5% {
                transform: rotate(-15deg);
            }
            25% {
                transform: rotate(-30deg);
            }
            37.5% {
                transform: rotate(-15deg);
            }
            50% {
                transform: rotate(0deg);
            }
            62.5% {
                transform: rotate(15deg);
            }
            75% {
                transform: rotate(30deg);
            }
            87.5% {
                transform: rotate(15deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }

        .select-img-group > div .btn-close:active {
            background-color: #c92709;
        }

        .img-num {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: #9d9d9d;
            font-size: 0.6875rem;
        }

        .select-time {
            position: relative;
            padding-top: 13px;
            padding-left: 7.5%;
        }

        .select-time > span {
            color: #9d9d9d;
            font-size: 0.6875rem;
        }

        .select-time .select-img-btn {
            background: transparent;
            position: absolute;
            right: 7px;
        }

        .select-time .select-img-btn > img {
            position: relative;
            top: -2px;
            width: 20px;
        }

        .btn-submit {
            color: #ffffff;
            background-color: #4298fd;
            border-radius: 4rem;
        }

        .btn-submit:active {
            background-color: #2779c4;
            color: #ffffff;
        }

        .btn-submit-position {
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 29px;
            margin-bottom: 30px;
            width: 76.07%;
            height: 40px;
            max-width: 210px;
            max-height: 40px;
            line-height: 40px;
            font-size: 0.75rem;
        }

        .btn-active img {
            width: 100%;
            min-height: 80px;
            max-height: 80px;
        }

        .btn-close {
            display: none;
        }

        .btn-active .btn-close {
            display: block;
        }
    </style>
</head>
<body>
<div class="bottom-sh">
    <ul class="aui-list aui-form-list">
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    报事地点
                </div>
                <div class="aui-list-item-input">
                    <input disabled="disabled" type="text" value="保利香槟金1期-H2栋-1单元-3103"/>
                </div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    联系人
                </div>
                <div class="aui-list-item-input">
                    <input type="text" value="吕布"/>
                </div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    联系电话
                </div>
                <div class="aui-list-item-input">
                    <input type="text" value="18170041111"/>
                </div>
            </div>
        </li>
    </ul>
    <div class="title-type">维修类型</div>
    <div class="btn-type-group">
        <div class="btn-type">
            <img src="../../../../image/find/repair/icon/water_un.png" alt="">
            <span>水</span>
        </div>
        <div class="btn-type">
            <img src="../../../../image/find/repair/icon/electricity_un.png" alt="">
            <span>电</span>
        </div>
        <div class="btn-type">
            <img src="../../../../image/find/repair/icon/fire_un.png" alt="">
            <span>可燃气</span>
        </div>
        <div class="btn-type">
            <img src="../../../../image/find/repair/icon/lock_un.png" alt="">
            <span>锁</span>
        </div>
        <div class="btn-type">
            <img src="../../../../image/find/repair/icon/other_un.png" alt="">
            <span>其他</span>
        </div>
    </div>

</div>
<div class="input-text-div">
    <textarea id="textInfo" maxlength="200" rows="6" placeholder="报事说明,请描述您遇到的问题"></textarea>
    <span class="font-num">
            <span>
                <label id="textLen">0</label>/200
            </span>
        </span>
</div>
<div class="select-img-group">
    <div class="img-item">
        <div class="btn-close" tapmode onclick="clickCloseImgItem(this)">X</div>
        <button class="btn-select-img" tapmode onclick="btnImgGroupClick(this)">
            <img src="../../../../image/applyKey/add.png">
        </button>
    </div>
    <div class="img-item aui-hide btn-active">
        <div class="btn-close" tapmode onclick="clickCloseImgItem(this)">X</div>
        <button class="btn-select-img" tapmode onclick="btnImgGroupClick(this)">
            <img src="">
        </button>
    </div>
    <div class="img-item aui-hide  btn-active">
        <div class="btn-close" tapmode onclick="clickCloseImgItem(this)">X</div>
        <button class="btn-select-img" tapmode onclick="btnImgGroupClick(this)">
            <img src="">
        </button>
    </div>
    <span class="img-num">
        <span>
            <label id="imgLen">0</label>/3
        </span>
    </span>
</div>
<div class="select-time">
    <span>2018-12-07 12:00:00</span>
    <button class="select-img-btn">
        <img src="../../../../image/find/repair/gray_lock.png"/>
    </button>
</div>
<div class="aui-btn btn-submit btn-submit-position">
    立即提交
</div>
</body>
</html>
<script type="text/javascript" src="../../../../script/api.js"></script>
<script>
    var UIAlbumBrowser;
    apiready = function () {
        /**
         * 图片加载器
         */
        UIAlbumBrowser = api.require('UIAlbumBrowser');
        api.parseTapmode();
        initBtnGroupClick();
    };
    document.getElementById("textInfo").oninput = function () {
        var text = this.value;
        $api.text(document.getElementById('textLen'), text.length)
    };


    /**
     * 类型按钮组的点击事件
     */
    function initBtnGroupClick() {
        var btnGroup = $api.domAll('.btn-type-group .btn-type');
        for (var i = 0; i < btnGroup.length; i++) {
            btnGroup[i].onclick = function () {
                var $img = $api.dom(this, 'img');
                var src = $api.attr($img, 'src').toString();
                var isHave = src.lastIndexOf('_un');
                if (isHave !== -1) {
                    src = src.replace('_un', '');
                } else {
                    var number = src.lastIndexOf('.');
                    src = src.substring(0, number) + '_un' + src.substring(number);
                }
                $api.attr($img, 'src', src);
            }
        }
    }

    /**
     * ios查看是否有相册权限
     */
    function checkPermission() {
        if (UIAlbumBrowser.requestAlbumPermissions) {
            UIAlbumBrowser.requestAlbumPermissions({}, function (ret, err) {
                if (!ret.isAccessPermissions) {
                    api.toast({
                        msg: '请先打开访问相册权限！',
                        duration: 1000,
                        location: 'bottom'
                    });
                }
            });
        }
    }

    /**
     * 选择图片的点击事件
     */
    function btnImgGroupClick() {
        UIAlbumBrowser.imagePicker({
            max: 3,
            styles: {
                bg: '#000000',
                //cameraImg: 'widget://res/cameraImg.png',
                mark: {
                    position: 'top_right',
                    size: 20
                },
                nav: {
                    bg: '#000000',
                    cancelColor: '#fff',
                    cancelSize: 16,
                    nextStepColor: '#7fff00',
                    nextStepSize: 16
                },
                thumbnail: { //（可选项）返回的缩略图配置，**建议本图片不要设置过大** 若已有缩略图，则使用已有的缩略图。若要重新生成缩略图，可先调用清除缓存接口api.clearCache()。
                    w: 100, //（可选项）数字类型；返回的缩略图的宽；默认：原图的宽度
                    h: 100 //（可选项）数字类型；返回的缩略图的宽；默认：原图的高度
                }
            },
            animation: true,
        }, function (ret) {
            if (!ret.eventType) {
                var imgList = [{
                    path: ret.originalPath
                }];
                setPathInImg(imgList);
                return;
            }
            if (!ret.list || ret.list.length <= 0) {
                var $imgItem = $api.domAll('.img-item');
                //隐藏后面两个按钮并把图片的src改变
                $api.addCls($imgItem[1], 'aui-hide');
                $api.addCls($imgItem[2], 'aui-hide');
                $api.attr($api.dom($imgItem[1], 'img'), 'src', '');
                $api.attr($api.dom($imgItem[2], 'img'), 'src', '');
                //修改第一个图片的src为默认，并改变图片为正常大小
                $api.removeCls($imgItem[0], 'btn-active');
                $api.attr($api.dom($imgItem[0], 'img'), 'src', '../../../../image/applyKey/add.png');
                //更换选中了几张的数字
                checkSelectImgLength(0);
                return;
            }
            if (ret.eventType === 'nextStep') {
                if (ret.list && ret.list.length > 0) {
                    setPathInImg(ret.list);
                }
                UIAlbumBrowser.closePicker();
            }
        });
    }

    /**
     * 点击删除图片的按钮时
     */
    function clickCloseImgItem($this) {
        var $imgItem = $api.domAll('.img-item');
        var hideItmeNum = 0;
        for (var i = 0; i < $imgItem.length; i++) {
            if ($api.hasCls($imgItem[i], 'aui-hide')) {
                hideItmeNum++;
            }
        }
        var parentNode = $this.parentNode;
        if (hideItmeNum !== 2) {
            $api.addCls(parentNode, 'aui-hide');
        }
        $api.removeCls(parentNode, 'btn-active');
        var $img = $api.first(parentNode, 'img');
        $api.attr($img, 'src', '../../../../image/applyKey/add.png');

        //更换选中了几张的数字
        checkSelectImgLength(false, function (num) {
            return --num;
        });
    }

    /**
     * 当选中图片时的回调
     * @param imgList 选中图片的信息列表
     */
    function setPathInImg(imgList) {
        var len = imgList.length;
        var $imgItem = $api.domAll('.img-item');
        var tmpArr = [];
        for (var j = 0; j < $imgItem.length; j++) {
            if (!$api.hasCls($imgItem[j], 'aui-hide')) {
                tmpArr.unshift($imgItem[j]);
            } else {
                tmpArr.push($imgItem[j]);
            }
        }
        $imgItem = tmpArr;

        //更换选中了几张的数字
        checkSelectImgLength(len);

        //闭包解决一切，垃圾apiCloud不支持let，不支持es6活不久
        for (var i = 0; i < len; i++) {
            (function (i) {
                UIAlbumBrowser.transPath({
                    path: imgList[i].path
                }, function (ret, err) {
                    var path = ret.path;
                    var $item = $imgItem[i];
                    //给当前img设置src
                    var $img = $api.dom($item, 'img');
                    $api.attr($img, 'src', path);
                    //给当前按钮删除隐藏
                    $api.removeCls($item, 'aui-hide');
                    //给图片设置100%宽btn-active
                    $api.addCls($item, 'btn-active');
                });
            })(i);
        }

        //清除
        for (var k = 2; k > len; k--) {
            $api.addCls($imgItem[k], 'aui-hide');
            $api.attr($api.dom($imgItem[k], 'img'), 'src', '');
        }


    }

    /**
     * 检查当前选了几张图片
     * return 图片的url
     */
    function checkSelectImgLength(num, fn) {
        if (num) {
            $api.text($api.dom('#imgLen'), num);
            return;
        }
        if (fn) {
            $api.text($api.dom('#imgLen'), fn($api.text($api.dom('#imgLen'))));
        }


        var res = [];
        var imgList = $api.domAll('.img-item img');
        for (var i = 0; i < imgList.length; i++) {
            if ($api.attr(imgList[i], 'src') !== '' && $api.attr(imgList[i], 'src') !== '../../../../image/applyKey/add.png') {
                res.push($api.attr(imgList[i], 'src'));
            }
        }
        var len = res.length;
        $api.text($api.dom('#imgLen'), len);
        return res;
    }
</script>
