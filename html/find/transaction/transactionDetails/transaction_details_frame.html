<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>办理详情的frame</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../css/aui.css"/>
    <style>
        body, html {
            background-color: #fff;
        }

        .div-header {
            height: 99px;
            box-sizing: border-box;
            background: url("../../../../image/find/repair/bg_details.png") no-repeat;
            -webkit-background-size: cover;
            background-size: cover;
        }

        .div-header .title {
            color: #ffffff;
            font-size: .625rem;
            padding-left: 20px;
            padding-top: 15px;
        }

        .div-header .group-circle {
            width: 85%;
            margin: 0 auto;
            text-align: center;
            padding-top: 8px;
        }

        .div-header .group-circle > * {
            display: inline-block;
        }

        .group-circle .circle {
            display: inline-block;
            background-color: #ffffff;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .group-circle .circle-active {
            background-color: #fbcf4b;
            box-sizing: unset;
            position: relative;
            top: 5px;
            left: -5px;
            border: 5px solid #72b499;
        }

        .group-circle .line {
            height: 2px;
            background-color: #a7cfe3;
            width: calc(25% - 24px);
            vertical-align: 4px;
        }

        .group-circle-item {
            width: 10px;
            position: relative;
        }

        .group-circle-item .circle-detail {
            float: left;
            padding-top: 7px;
            position: absolute;
            left: -1.25rem;
            width: 3rem;
            color: #fefeff;
            font-size: 0.625rem;
        }
    </style>
    <style>
        .box {
            position: relative;
            width: 95%;
            box-sizing: border-box;
            margin: 12.5px auto;
            padding-bottom: 15px;
            border-radius: 10px;
            -webkit-box-shadow: 2px 2px 10px #efefef, -2px -2px 10px #efefef;
            -moz-box-shadow: 2px 2px 10px #efefef, -2px -2px 10px #efefef;
            box-shadow: 2px 2px 10px #efefef, -2px -2px 10px #efefef;
        }

        .box .box-title {
            position: relative;
            font-size: 0.875rem;
            padding-left: 12px;
            padding-top: 14px;
        }

        .box .box-title span:last-child {
            position: absolute;
            right: 10px;
            white-space: nowrap;
            text-align: right;
            color: #7f7f7f;
            font-size: 0.6875rem;
        }

        .box .box-title::before {
            display: inline-block;
            position: relative;
            content: "";
            top: 1.8px;
            width: 2px;
            height: 0.85rem;
            background: #4298fd;
            margin-right: 3.5px;
        }

        .box .box-title-small {
            padding-left: 15px;
            padding-right: 10px;
            padding-top: 6px;
            font-size: 0.75rem;
            line-height: 0.85rem;
        }

        .box .box-info {
            padding-left: 15px;
            padding-top: 18px;
            font-size: 0.6875rem;
            color: #474747;
        }

        .box-info > div {
            padding-top: 3px;
        }

        .box-info .img-list {
            position: relative;
            left: -5px;
            display: inline-block;
        }

        .box-info .img-list > img {
            position: relative;
            top: 2px;
            width: 13px;
            margin: 0 1px;
            display: inline-block;
        }

        .btn-evaluation {
            position: absolute;
            display: none;
            right: 20.5px;
            bottom: 30px;
            width: 70px;
            height: 25px;
            text-align: center;
            border-radius: 1rem;
            background: #4298fd;
            font-size: 0.75rem;
            line-height: 25px;
            color: #ffffff;
        }

        .btn-evaluation:active {
            background: #3986e2;
        }
    </style>
    <style>
        .time-line-group {
            padding: 12px 0 0;
            overflow: hidden;
        }

        .time-line-group .item {
            position: relative;
            /*overflow: hidden;*/
            padding-bottom: 10px;
            height: 70px;
            color: #474747;
        }

        .time-line-group .item > * {
            display: inline-block;
        }

        .time-line-group .item-time {
            vertical-align: top;
            width: 2.9rem;
            padding-left: 17px;
            font-size: 0.625rem;
        }

        .time-line-group .item-time > span {
            display: block;
        }

        .time-line-group .circle {
            position: relative;
            background-color: #fff;
            top: .6rem;
            vertical-align: top;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-sizing: border-box;
            font-size: 0.625rem;
            border: 3px solid #4298fd;
        }

        .time-line-group .item:first-child .circle::after {
            position: relative;
            top: 15px;
            left: 1.76px;
            content: "";
            float: left;
            width: 2px;
            height: 900px;
            background-color: #a7a7a7;
        }

        .time-line-group .item:last-child .circle::after {
            position: relative;
            top: 9px;
            left: 1px;
            content: "";
            float: left;
            width: 5px;
            height: 900px;
            background-color: #ffffff;
        }

        .time-line-group .item-inner {
            width: calc(85% - 25px - 60px);
            margin-left: 8px;
        }

        .time-line-group .item-inner > div {
            font-size: .75rem;
        }

        .time-line-group .item-inner > p {
            font-size: .625rem;
        }

        .time-line-group .item-inner .info {
            position: relative;
            top: 6px;
        }

        .time-line-group .item:first-child .item-time span:first-child {
            position: relative;
            left: -0.28rem;
            font-size: 0.75rem;
            color: black;
        }

        .time-line-group .item:first-child .circle {
            box-sizing: unset;
            background-color: #fbcf4b;
            position: relative;
            /*top: 5px;*/
            left: -5px;
            border: 5px solid #fef0c8;
        }

        .time-line-group .item:first-child .circle::after {
            top: 17px;
            left: 39%;
        }

        .time-line-group .item:first-child .item-inner {
            margin-left: -1px;
        }

        .text-red {
            color: #ff4747;
        }

        .btn-disable {
            background-color: #a5a5a5;
        }

        .btn-disable:active {
            background-color: #a5a5a5;
        }
    </style>
</head>

<body>
<div class="div-header">
    <div class="title">
        <span>报事单号：</span>
        <span id="number"></span>
    </div>
    <div>
        <div class="group-circle">
            <div class="group-circle-item">
                <i class="circle"></i>
                <span class="circle-detail">申请成功</span>
            </div>
            <div class="line"></div>
            <div class="group-circle-item">
                <i class="circle"></i>
                <span class="circle-detail">已受理</span>
            </div>
            <div class="line"></div>
            <div class="group-circle-item">
                <i class="circle"></i>
                <span class="circle-detail">处理中</span>
            </div>
            <div class="line"></div>
            <div class="group-circle-item">
                <i class="circle"></i>
                <span class="circle-detail">待评价</span>
            </div>
            <div class="line"></div>
            <div class="group-circle-item">

                <i class="circle"></i>
                <span class="circle-detail">已评价</span>
            </div>
        </div>
        <!--<div class="group-circle-detail">-->
        <!--<span class="circle-detail">申请成功</span>-->
        <!--<span class="circle-detail">已受理</span>-->
        <!--<span class="circle-detail">处理中</span>-->
        <!--<span class="circle-detail">待评价</span>-->
        <!--<span class="circle-detail">已评价</span>-->
        <!--</div>-->
    </div>
</div>

<section class="box">
    <div class="box-title"><span>办理内容 </span><span id="createTime"></span></div>
    <div class="box-title-small" id="content">

    </div>
    <div id="box-info" class="box-info">
        <div>服务人员：<span id="processor"></span></div>
        <div>联系电话：<span id="processorPhone"></span></div>
        <div>服务评价：
            <div class="img-list" id="starGroup">
                <img src="../../../../image/find/repair/star_ash.png">
                <img src="../../../../image/find/repair/star_ash.png">
                <img src="../../../../image/find/repair/star_ash.png">
                <img src="../../../../image/find/repair/star_ash.png">
                <img src="../../../../image/find/repair/star_ash.png">
            </div>
        </div>
    </div>
    <div id="evaluation" class="btn-evaluation" tapmode onclick="clickEvaluation(this)">评价</div>
</section>
<section class="box" style="margin-top: 8px;">
    <div class="box-title">进度信息</div>
    <div class="time-line-group" id="lineGroup">
    </div>
</section>
</body>

</html>
<script type="text/javascript" src="../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../script/static.js"></script>
<script>
    apiready = function () {
        initInfo(api.pageParam.id);
    };

    /**
     * 初始化信息
     * @param id 办理编号
     */
    function initInfo(id) {
        api.showProgress({
            title: '正在加载',
            msg: '请稍后'
        });
        api.ajax({
            url: Static.IP + '/api/app/communitywanli/userService/getByBusinessHandlingId',
            method: 'get',
            dataType: 'json',
            data: {
                values: {
                    businessHandlingId: id,
                    mac: api.deviceId
                }
            }
        }, function (ret, err) {
            api.hideProgress();
            if (ret) {
                if (!ret.resultStatus) {
                    api.toast({
                        msg: ret.message,
                        duration: 3000,
                        location: 'bottom'
                    });
                } else {
                    render(ret.object);
                }
            } else {
                api.toast({
                    msg: err.msg,
                    duration: 3000,
                    location: 'bottom'
                });
            }
        });
    }

    /**
     * 去评价
     */
    function clickEvaluation($this) {
        if ($api.hasCls($this, 'btn-disable')) return;
        api.openWin({
            name: 'evaluationWin',
            url: '../evaluation/service_evaluation.html',
            pageParam: api.pageParam
        })

    }

    /**
     * 数据渲染在宽阔的草原上
     * @param obj
     */
    function render(obj) {
        $api.text($api.dom('#number'), obj.number);
        var index = getIndexCircleByStatus(obj.status);
        if (index === 4) {
            var $dom = $api.dom('#evaluation');
            $api.addCls($dom, 'btn-disable');
            $api.text($dom, '已评价');
        }
        if (index > 2) {
            $api.text($api.dom('#processor'), obj.processor);
            $api.text($api.dom('#processorPhone'), obj.processorPhone);
            $api.dom('#evaluation').style.display = 'block';
            setStarGroupByEvaluateTotal(obj.evaluateTotal);
        } else {
            $api.dom('#box-info').style.display = 'none';
        }

        var element = $api.domAll('.group-circle .group-circle-item')[index];
        $api.addCls($api.first(element, 'i'), 'circle-active');
        $api.text($api.dom('#content'), Static.getDictionByCode(obj.type));
        $api.text($api.dom('#createTime'), obj.gmtCreate);

        //进度信息
        var $lineGroup = $api.dom('#lineGroup');
        var groupItemArr = [{
            date: obj.gmtCreate.substring(5, 10),
            time: obj.gmtCreate.substring(11, 16),
            content: '申请办理成功，正在处理中'
        }, {
            date: obj.gmtCreate.substring(5, 10),
            time: obj.gmtCreate.substring(11, 16),
            content: '您的办理等待受理'
        }];

        if (index >= 1) {
            groupItemArr.push({
                date: obj.receiverTime.substring(5, 10),
                time: obj.receiverTime.substring(11, 16),
                status: '已受理',
                content: '您的办理业务已受理，受理人是：' + obj.receiver
            });
        }
        if (index >= 2) {
            groupItemArr.push({
                date: obj.processorStartTime.substring(5, 10),
                time: obj.processorStartTime.substring(11, 16),
                status: '正在处理',
                content: obj.processor + ' 正在处理，联系电话：<span class="text-red">' + obj.processorPhone + '</span>'
            });
        }
        if (index >= 3) {
            groupItemArr.push({
                date: obj.processorEndTime.substring(5, 10),
                time: obj.processorEndTime.substring(11, 16),
                status: '已处理',
                content: obj.processor + '已处理完成，愿我们的十分努力换您的五星好评'
            });
        }
        for (var j = groupItemArr.length - 1; j > -1; j--) {
            $api.append($lineGroup, [
                '<div class="item"><div class="item-time">',
                '<span>' + groupItemArr[j].date + '</span><span>' + groupItemArr[j].time + '</span>',
                '</div>',
                '<i class="circle"></i>',
                '<div class="item-inner">',
                groupItemArr[j].status ? '<div>' + groupItemArr[j].status + '</div>' : '',
                '<p class=' + (groupItemArr[j].status ? '' : 'info') + '>' + groupItemArr[j].content + '</p>',
                '</div>',
                '</div>'
            ].join(''));
        }
    }

    function setStarGroupByEvaluateTotal(evaluate) {
        if (!evaluate) return;
        var all = $api.domAll('#starGroup img');
        for (var i = 0; i < evaluate; i++) {
            $api.attr(all[i], 'src', '../../../../image/find/repair/star_blue.png');
        }
    }

    function getIndexCircleByStatus(status) {
        var name = Static.getDictionByCode(status);
        switch (name) {
            case '申请成功':
                return 0;
            case '已受理':
                return 1;
            case '处理中':
                return 2;
            case '待评价':
                return 3;
            case '已评价':
                return 4;
            default:
                return 0;
        }
    }

</script>
