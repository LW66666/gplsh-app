<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>我的资料修改的frame</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../css/aui.css"/>
    <style>
        body, html {
            background-color: #ffffff;
            font-size: 20px;
        }

        .font {
            font-size: .75rem;
        }

        .aui-list {
            margin-top: 10px;
            box-shadow: 0 -10px #f6f6f6;
        }

        .aui-list > .aui-list-item {
            position: relative;
            width: 100%;
            padding-left: 20px !important;
            margin: 0;
            height: 49px;
            box-sizing: border-box;
            background-position: bottom !important;
        }

        .aui-list .aui-list-item-inner {
            padding-right: 1.5rem;
        }

        .aui-list .aui-list-item.bui-item {
            background-color: #ffffff;
        }

        .aui-list-item-arrow .aui-pull-left {
            width: 100%;
        }

        .aui-pull-left {
            display: flex;
            width: 100%;
        }

        .aui-pull-left label {
            height: 49px;
            line-height: 49px;
            flex: 3;
        }

        .aui-pull-left input {
            height: 49px;
            line-height: 49px;
            flex: 7;
            color: #6d6c6c;
            font-size: 0.75rem;
        }

        .aui-pull-left span {
            display: flex;
            justify-content: left;
            align-items: center;
            flex: 7;
            font-size: .75rem;
        }

        .aui-pull-left input:focus {
            color: #000000;
        }

        .aui-pull-left .text-black {
            color: black;
        }
        .prop {
            position: relative;
            width: 100%;
            height: 0px;
            -webkit-transition: all 0.3s;
            -moz-transition: all 0.3s;
            -ms-transition: all 0.3s;
            -o-transition: all 0.3s;
            transition: all 0.3s;
        }
    </style>
</head>

<body>

<ul class="aui-list">
    <li class="aui-list-item bui-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="nickname">昵称</label>
                <input id="nickname" type="text" value="狗子"/>
            </div>
        </div>
    </li>
    <li class="aui-list-item" tapmode onclick="clickGender(this)">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="gender">性别</label>
                <input id="gender" disabled="disabled" type="text" value="未知"/>
            </div>
        </div>
    </li>
    <li class="aui-list-item" tapmode onclick="clickBloodType(this)">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="bloodType">血型</label>
                <input id="bloodType" disabled="disabled" type="text" value="A"/>
            </div>
        </div>
    </li>
    <li class="aui-list-item" tapmode onclick="clickBirthday(this)">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="birthday">生日</label>
                <input id="birthday" disabled="disabled" type="text" value="2022-12-22"/>
            </div>
        </div>
    </li>
    <li class="aui-list-item bui-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="constellation">星座</label>
                <input id="constellation" disabled="disabled" type="text" value="疯子坐"/>
            </div>
        </div>
    </li>
    <li class="aui-list-item bui-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="region">地区</label>
                <input id="region" class="text-black" disabled="disabled" type="text" value="江西南昌"/>
            </div>
        </div>
    </li>
</ul>

<ul class="aui-list">
    <li class="aui-list-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="occupation">职业</label>
                <input id="occupation" type="text" value="铲屎官"
                       onblur="$api.css($api.dom('.prop'),'height:0px;');" onfocus="foucs(100)" onclick="foucs(100)" />
            </div>
        </div>
    </li>
    <li class="aui-list-item bui-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="identity">小区身份</label>
                <input class="text-black" id="identity" disabled="disabled" type="text" value="普通用户"/>
            </div>
        </div>
    </li>
    <li class="aui-list-item bui-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label>小区坐标</label>
                <span>
                    光明小区-1期-北区-2栋-2单元-1202
                </span>
            </div>
        </div>
    </li>
</ul>

<ul class="aui-list">
    <li class="aui-list-item">
        <div class="aui-list-item-inner font">
            <div class="aui-pull-left">
                <label for="autograph">签名</label>
                <input id="autograph" type="text" placeholder="悄悄的我来了，什么也没留下！"
                       onblur="$api.css($api.dom('.prop'),'height:0px;');" onfocus="foucs(300)" onclick="foucs(300)" value=""/>
            </div>
        </div>
    </li>

    <li class="aui-list-item" tapmode onclick="clickTag()">
        <div class="aui-list-item-inner aui-list-item-arrow font">
            <div class="aui-pull-left">
                <label for="tag">标签</label>
                <input id="tag" disabled="disabled" type="text" placeholder="白富美、高富帅、有为青年、完美主义" value=""/>
            </div>
        </div>
    </li>
</ul>
<div class="prop"></div>

</body>

</html>
<script type="text/javascript" src="../../../../script/api.js"></script>
<script>
    var user=$api.getStorage("userObj");
    var mac=$api.deviceId;
    var UIActionSelector;
    apiready = function () {
        UIActionSelector = api.require('UIActionSelector');

        setUserInfo();
    };

    /**
     * 选择性别
     */
    function clickGender($this) {
        var $input = $api.dom($this, '#gender');
        var val = $input.value;
        if (!val || val === '未知') {
            val = '男';
        }
        var datas = [
            {
                name: '男',
            }, {
                name: '女'
            }
        ];
        if (val === '女') {
            var tmp=datas[0];
            datas[0] = datas[1];
            datas[1] = tmp;
        }
        UIActionSelector.open({
            datas:datas,
            layout: {
                row: 3,
                col: 1,
                height: 30,
                size: 16,
                sizeActive: 16,
                rowSpacing: 5,
                colSpacing: 10,
                maskBg: 'rgba(0,0,0,0.2)',
                bg: '#fff',
                color: '#878787',
                colorActive: '#4298fd',
                colorSelected: '#4298fd'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 16,
                w: 90,
                h: 35,
                bg: '#fff',
                bgActive: '#fff',
                color: '#000000',
                colorActive: '#000000'
            },
            ok: {
                text: '确定',
                size: 16,
                w: 90,
                h: 35,
                bg: '#fff',
                bgActive: '#fff',
                color: '#4298fd',
                colorActive: '#4298fd'
            },
            title: {
                text: '请选择性别',
                size: 18,
                h: 40,
                bg: '#fff',
                color: '#000000'
            },
            fixedOn: api.frameName
        }, function (ret, err) {
            if (ret && ret.eventType && ret.selectedInfo) {
                $input.value = ret.selectedInfo[0].name;
            }
        });
    }

    /**
     * 点击选择血型
     */
    function clickBloodType($this) {
        var $input = $api.dom($this, '#bloodType');
        var val = $input.value;
        var datas = [
            {name:'A'},
            {name:'B'},
            {name:'AB'},
            {name:'O'},
            {name:'其它'}
        ];

        for (var i = 0; i < datas.length; i++) {
            if (datas[i].name === val) {
                var tmp = datas[i];
                datas.splice(i,1);
                datas.unshift(tmp);
            }
        }
        UIActionSelector.open({
            datas:datas,
            layout: {
                row: 7,
                col: 1,
                height: 30,
                size: 16,
                sizeActive: 16,
                rowSpacing: 15,
                colSpacing: 10,
                maskBg: 'rgba(0,0,0,0.2)',
                bg: '#fff',
                color: '#878787',
                colorActive: '#4298fd',
                colorSelected: '#4298fd'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 16,
                w: 90,
                h: 35,
                bg: '#fff',
                bgActive: '#fff',
                color: '#000000',
                colorActive: '#000000'
            },
            ok: {
                text: '确定',
                size: 16,
                w: 90,
                h: 35,
                bg: '#fff',
                bgActive: '#fff',
                color: '#4298fd',
                colorActive: '#4298fd'
            },
            title: {
                text: '请选择血型',
                size: 18,
                h: 40,
                bg: '#fff',
                color: '#000000'
            },
            fixedOn: api.frameName
        }, function (ret, err) {
            if (ret && ret.eventType && ret.selectedInfo) {
                $input.value = ret.selectedInfo[0].name;
            }
        });
    }

    /**
     * 点击选择生日
     */
    function clickBirthday($this) {
        var $input = $api.dom($this, '#birthday');
        var d = new Date();
        var now = [d.getFullYear, d.getMonth + 1, d.getDate];
        api.openPicker({
            type: 'date',
            date: $input.value || now.join('-'),
            title: '请选择日期'
        }, function (ret, err) {
            if (ret) {
                var $constellation = $api.dom('#constellation');
                var m = ret.month;
                var d = ret.day;
                var dateArr = [
                    ret.year,
                    m > 9 ? m : '0' + m,
                    d > 9 ? d : '0' + d
                ];
                $input.value = dateArr.join('-');
                $constellation.value = getConstellation(m, d);
            }
        });
    }

    /**
     * 月日获取星座
     */
    function getConstellation(m, d) {
        var s = "魔羯水瓶双鱼牡羊金牛双子巨蟹狮子处女天秤天蝎射手魔羯";
        var arr = [20, 19, 21, 21, 21, 22, 23, 23, 23, 23, 22, 22];
        return s.substr(m * 2 - (d < arr[m - 1] ? 2 : 0), 2)+'座';
    }

    /**
     * 点击选择标签
     */
    function clickTag() {
        api.openWin({
            name: 'selectTagWin',
            url: './selectTag/select_tag.html'
        })
    }

    /**
     * 设置用户数据
     */
    function setUserInfo() {
        var phone=user.cellphone;
        api.ajax({
                url: ip+'/api/app/communitywanli/user/getDetail',
                method: 'get',
                timeout: 10,
                dataType: 'json',
                returnAll: false,
                data: {
                    values:{
                        cellphone: phone,
                        mac:mac
                    }
                }
            },
            function (ret, err) {
                api.refreshHeaderLoadDone();
                api.hideProgress();
                if (ret!=""){
                    if (ret.message=="请重新登录") {
                        setTimeout(function () {
                            api.openWin({
                                name: 'pw_login_win',
                                url: '../../login/pw_login_win.html',
                            });
                        },1000);
                    }
                    if (!ret.resultStatus) {
                        api.toast({
                            msg: ret.message,
                            duration: 3000,
                            location: 'bottom'
                        });
                    }
                    else {
                        var obj=ret.object;
                        var signature=(obj.user.signature=="")?"悄悄的我来了，什么也没留下":obj.user.signature;
                        var sex=(obj.user.gender==0)?"女":"男";

                        $api.val($api.dom("bloodType"),obj.user.bloodType);
                        $api.val($api.dom("#nickname"),obj.user.nickname);
                        $api.val($api.dom("#gender"),sex);
                        $api.val($api.dom("#birthday"),obj.user.birthday);
                        $api.val($api.dom("#constellation"),obj.household.constellation);
                        $api.val($api.dom("#occupation"),obj.user.profession);
                        $api.val($api.dom("#autograph"),signature);
                        if (obj.community==undefined){
                            $api.val($api.dom("#identity"),"");
                            $api.val($api.dom(".aui-pull-left span"),"");
                            $api.val($api.dom("#region"),"");
                        }else {
                            $api.val($api.dom("#identity"),obj.user.role);
                            $api.val($api.dom("#region"),obj.community.provinceName+obj.community.cityName);
                            $api.val($api.dom(".aui-pull-left span"),obj.householdRooms[0].communityName+"-"+
                                obj.householdRooms[0].zoneName+"-"+obj.householdRooms[0].buildingName+"-"+obj.householdRooms[0].unitName
                                +"-"+obj.householdRooms[0].roomNum);
                        }
                        if(obj.label.length==0){
                            $api.html($api.dom("#tag"),"");
                        }else {
                            api.ajax({
                                    url: ip+'/api/app/communitywanli/label/listLabelByUserId',
                                    method: 'get',
                                    timeout: 10,
                                    dataType: 'json',
                                    returnAll: false,
                                    data: {
                                        values:{
                                            cellphone: phone,
                                            mac:mac
                                        }
                                    }
                                },
                                function (ret, err) {
                                    if (ret!=""){
                                        if (ret.message=="请重新登录") {
                                            setTimeout(function () {
                                                api.openWin({
                                                    name: 'pw_login_win',
                                                    url: '../../login/pw_login_win.html',
                                                });
                                            },1000);
                                        }
                                        if (!ret.resultStatus) {
                                            api.toast({
                                                msg: ret.message,
                                                duration: 3000,
                                                location: 'bottom'
                                            });
                                        }
                                        else {
                                            var label="";
                                            var objArr=ret.object;
                                            for(var obj of objArr){
                                                label+=obj.name+" ";
                                            }
                                            $api.attr($api.dom("#tag"),"placeholder",label);
                                        }
                                    }
                                    else {
                                        api.toast({
                                            msg: err.msg,
                                            duration: 3000,
                                            location: 'bottom'
                                        });
                                    }
                                });
                        }

                    }
                }
                else {
                    api.toast({
                        msg: err.msg,
                        duration: 3000,
                        location: 'bottom'
                    });
                }
            });
    }

    /**
     * 保存用户信息
     */
    function saveUserInfo() {
        var checkStatus=true;
        var pat=/^[\u4e00-\u9fa5_a-zA-Z0-9,，。！；‘’“”\.;\:"'!]+$/;
        var phone=user.cellphone;
        var nickname= $api.val($api.dom("#nickname"));
        var gender= ($api.val($api.dom("#gender"))=="男")?1:0;
        var birthday= $api.val($api.dom("#birthday"));
        var bloodType= $api.val($api.dom("#bloodType"));
        var profession= $api.val($api.dom("#occupation"));//职业
        var signature= $api.val($api.dom("#autograph"));
        var constellation= $api.val($api.dom("#constellation"));
        if (!pat.test(nickname) && nickname!=""){
            api.toast({
                msg: "昵称中含有非法字符",
                duration: 3000,
                location: 'bottom'
            });
            checkStatus=false;
        }
        else if (nickname.length>10){
            api.toast({
                msg: "昵称过长",
                duration: 3000,
                location: 'bottom'
            });
            checkStatus=false;
        }
        else {
            if (!pat.test(profession) && profession!=""){
                api.toast({
                    msg: "职业中含有非法字符",
                    duration: 3000,
                    location: 'bottom'
                });
                checkStatus=false;
            }else if (profession.length>10){
                api.toast({
                    msg: "职业过长",
                    duration: 3000,
                    location: 'bottom'
                });
                checkStatus=false;
            }else {
                if (!pat.test(signature) && signature!=""){
                    api.toast({
                        msg: "签名中含有非法字符",
                        duration: 3000,
                        location: 'bottom'
                    });
                    checkStatus=false;
                }else if (signature.length>40){
                    api.toast({
                        msg: "签名过长",
                        duration: 3000,
                        location: 'bottom'
                    });
                    checkStatus=false;
                }else {
                    checkStatus=true;
                }
            }
        }

        if (checkStatus){
            api.ajax({
                    url: ip+'/api/app/communitywanli/login/updateUserInfo',
                    method: 'patch',
                    timeout: 10,
                    dataType: 'json',
                    returnAll: false,
                    data: {
                        values:{
                            nickname: nickname,
                            gender: gender,
                            cellphone: phone,
                            birthday: birthday,
                            bloodType: bloodType,
                            profession: profession,
                            signature: signature,
                            constellation: constellation,
                            mac:mac
                        }
                    }
                },
                function (ret, err) {
                    api.refreshHeaderLoadDone();
                    api.hideProgress();
                    if (ret!=""){
                        if (ret.message=="请重新登录") {
                            setTimeout(function () {
                                api.openWin({
                                    name: 'pw_login_win',
                                    url: '../../login/pw_login_win.html',
                                });
                            },1000);
                        }
                        if (!ret.resultStatus) {
                            api.toast({
                                msg: ret.message,
                                duration: 3000,
                                location: 'bottom'
                            });
                        }
                        else {
                            api.toast({
                                msg: "保存成功",
                                duration: 3000,
                                location: 'bottom'
                            });

                            api.execScript({
                                name: 'userInfoWin',
                                frameName: 'user_info_frame',
                                script: "refresh()"
                            });
                        }
                    }
                    else {
                        api.toast({
                            msg: err.msg,
                            duration: 3000,
                            location: 'bottom'
                        });
                    }
                });
        }
    }

    function foucs(h) {
        $api.css($api.dom(".prop"),"height:"+h+"px;");
        window.scrollTo(0, 100) // 并且最好使用 window.scrollTo 方法
        setTimeout(() => window.scrollTo(0, 10000), 500) // 还可以延迟一会执行
    }
</script>